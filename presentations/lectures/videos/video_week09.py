"""
PDF to Video - Week 09: CI/CD
"""
import asyncio
import edge_tts
from pathlib import Path
from pdf2image import convert_from_path
from moviepy.editor import ImageClip, AudioFileClip, concatenate_videoclips

PDF_FILE = "week09-cicd.pdf"
OUTPUT_VIDEO = "week09-cicd-lecture.mp4"
VOICE = "th-TH-NiwatNeural"
RATE = "-15%"
DPI = 200

SCRIPTS = [
    """‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà 9 ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á CI/CD...
    ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô!...
    ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ Automation...
    ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Build Test ‡πÅ‡∏•‡∏∞ Deploy ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö...
    CI/CD ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£...
    pytest Testing...
    GitHub Actions...
    Jenkins...
    ‡πÅ‡∏•‡∏∞ Lab 8 ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """CI/CD ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏£‡∏±‡∏ö...
    CI ‡∏¢‡πà‡∏≠‡∏°‡∏≤‡∏à‡∏≤‡∏Å Continuous Integration...
    Build ‡πÅ‡∏•‡∏∞ Test ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà Push ‡πÇ‡∏Ñ‡πâ‡∏î...
    CD ‡∏¢‡πà‡∏≠‡∏°‡∏≤‡∏à‡∏≤‡∏Å Continuous Deployment...
    Deploy ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠ Test ‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á CI/CD ‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ô...
    ‡πÑ‡∏î‡πâ Feedback ‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß...
    Deploy ‡πÑ‡∏î‡πâ‡∏ö‡πà‡∏≠‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢...
    ‡∏ó‡∏µ‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """pytest ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏£‡∏±‡∏ö...
    Framework ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Test ‡πÉ‡∏ô Python...
    ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢...
    ‡∏£‡∏±‡∏ô Test ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...
    ‡∏™‡∏£‡πâ‡∏≤‡∏á Coverage Report ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Test ‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå test_*.py...
    ‡∏™‡∏£‡πâ‡∏≤‡∏á function def test_*...
    ‡πÉ‡∏ä‡πâ assert ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå...
    ‡∏£‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á pytest ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """GitHub Actions ‡∏Ñ‡∏£‡∏±‡∏ö...
    CI/CD ‡∏ó‡∏µ‡πà built-in ‡∏°‡∏≤‡∏Å‡∏±‡∏ö GitHub...
    ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Workflow ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå YAML...
    Trigger ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Push ‡∏´‡∏£‡∏∑‡∏≠ Pull Request...
    ‡∏£‡∏±‡∏ô‡∏ö‡∏ô GitHub Servers ‡∏ü‡∏£‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """Jenkins ‡∏Ñ‡∏£‡∏±‡∏ö...
    CI/CD Server ‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏°‡∏≤‡∏Å...
    Self-hosted ‡∏£‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏á...
    ‡∏°‡∏µ Plugins ‡∏°‡∏≤‡∏Å‡∏°‡∏≤‡∏¢...
    ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """Pipeline ‡∏Ñ‡∏£‡∏±‡∏ö...
    Push ‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ç‡∏∂‡πâ‡∏ô GitHub...
    Trigger CI/CD Pipeline...
    Build Docker Images...
    Run Tests...
    Deploy ‡∏ñ‡πâ‡∏≤ Test ‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """Lab 8 ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 3.75 ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå...
    ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô pytest Tests...
    ‡∏™‡∏£‡πâ‡∏≤‡∏á GitHub Actions Workflow...
    ‡∏™‡∏£‡πâ‡∏≤‡∏á Jenkinsfile...
    ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Pipeline...
    ‡πÄ‡∏î‡∏î‡πÑ‡∏•‡∏ô‡πå ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå 23:59 ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö!...
    ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 9 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ‡πÅ‡∏•‡∏∞ 8 Labs!...
    ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥ Project Phase ‡πÅ‡∏•‡πâ‡∏ß...
    ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡∏Ñ‡∏£‡∏±‡∏ö!""",
]

async def generate_audio(text, output_file):
    communicate = edge_tts.Communicate(text, VOICE, rate=RATE)
    await communicate.save(output_file)

async def generate_all_audio():
    Path("audio").mkdir(exist_ok=True)
    print("üé§ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á...")
    for i, script in enumerate(SCRIPTS, 1):
        await generate_audio(script, f"audio/slide_{i:02d}.mp3")
        print(f"  ‚úÖ Slide {i}/{len(SCRIPTS)}")

def convert_pdf_to_images():
    Path("images").mkdir(exist_ok=True)
    print("üñºÔ∏è ‡πÅ‡∏õ‡∏•‡∏á PDF...")
    images = convert_from_path(PDF_FILE, dpi=DPI)
    for i, img in enumerate(images, 1):
        img.save(f"images/slide_{i:02d}.png", "PNG")
    return len(images)

def create_video(num_slides):
    print("üé¨ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠...")
    clips = []
    for i in range(1, num_slides + 1):
        img, aud = f"images/slide_{i:02d}.png", f"audio/slide_{i:02d}.mp3"
        if Path(aud).exists():
            audio = AudioFileClip(aud)
            clip = ImageClip(img).set_duration(audio.duration).set_audio(audio)
        else:
            clip = ImageClip(img).set_duration(5)
        clips.append(clip)
    final = concatenate_videoclips(clips, method="compose")
    final.write_videofile(OUTPUT_VIDEO, fps=24, codec="libx264", audio_codec="aac", verbose=False, logger=None)
    final.close()
    print(f"‚úÖ {OUTPUT_VIDEO}")

async def main():
    print(f"üé¨ Week 09: CI/CD")
    if not Path(PDF_FILE).exists():
        print(f"‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö {PDF_FILE}")
        return
    await generate_all_audio()
    num = convert_pdf_to_images()
    create_video(min(num, len(SCRIPTS)))

if __name__ == "__main__":
    asyncio.run(main())
