"""
PDF to Video - Week 08: Docker Compose
"""
import asyncio
import edge_tts
from pathlib import Path
from pdf2image import convert_from_path
from moviepy.editor import ImageClip, AudioFileClip, concatenate_videoclips

PDF_FILE = "week08-docker-compose.pdf"
OUTPUT_VIDEO = "week08-docker-compose-lecture.mp4"
VOICE = "th-TH-NiwatNeural"
RATE = "-15%"
DPI = 200

SCRIPTS = [
    """‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà 8 ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Docker Compose...
    ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô‡∏´‡∏•‡∏≤‡∏¢ Services ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô...
    ‡∏î‡πâ‡∏ß‡∏¢ Docker Compose ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö...
    Docker Compose ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£...
    docker-compose.yml...
    Multi-container Applications...
    ‡πÅ‡∏•‡∏∞ Lab 7 ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """Docker Compose ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ô‡∏´‡∏•‡∏≤‡∏¢ Containers ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô...
    ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå YAML ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß...
    ‡∏™‡∏±‡πà‡∏á‡∏£‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß...
    ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Application ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢ Services ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """docker-compose.yml ‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Services ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£...
    ‡∏£‡∏∞‡∏ö‡∏∏ Image ‡∏´‡∏£‡∏∑‡∏≠ Build context...
    ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Ports ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î...
    ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Environment variables...
    ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Dependencies ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Services ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """Advanced-RAG-Docker ‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏°‡∏µ 6 Services...
    OpenSearch ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Vector Database...
    Embedding Service ‡∏™‡∏£‡πâ‡∏≤‡∏á Embeddings...
    Search API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...
    Backend API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö RAG...
    Frontend Streamlit UI...
    ‡πÅ‡∏•‡∏∞ Ollama ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LLM ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """Docker Network ‡∏Ñ‡∏£‡∏±‡∏ö...
    Services ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô Docker Network...
    ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ Service ‡πÄ‡∏õ‡πá‡∏ô hostname...
    ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á hardcode IP Address...
    ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö...
    docker-compose up -d ‡∏£‡∏±‡∏ô Services...
    docker-compose ps ‡∏î‡∏π Status...
    docker-compose logs ‡∏î‡∏π Logs...
    docker-compose down ‡∏´‡∏¢‡∏∏‡∏î Services...
    docker-compose down -v ‡∏•‡∏ö Volumes ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """Lab 7 ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 3.75 ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå...
    Clone Advanced-RAG-Docker...
    ‡∏®‡∏∂‡∏Å‡∏©‡∏≤ docker-compose.yml...
    ‡∏£‡∏±‡∏ô 6 Services...
    ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Application...
    ‡πÄ‡∏î‡∏î‡πÑ‡∏•‡∏ô‡πå ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå 23:59 ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?...
    ‡πÅ‡∏•‡πá‡∏ö‡∏ô‡∏µ‡πâ‡∏™‡∏ô‡∏∏‡∏Å ‡πÑ‡∏î‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö RAG ‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á!...
    ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡πÅ‡∏•‡πá‡∏ö 7 ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö!""",
]

async def generate_audio(text, output_file):
    communicate = edge_tts.Communicate(text, VOICE, rate=RATE)
    await communicate.save(output_file)

async def generate_all_audio():
    Path("audio").mkdir(exist_ok=True)
    print("üé§ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á...")
    for i, script in enumerate(SCRIPTS, 1):
        await generate_audio(script, f"audio/slide_{i:02d}.mp3")
        print(f"  ‚úÖ Slide {i}/{len(SCRIPTS)}")

def convert_pdf_to_images():
    Path("images").mkdir(exist_ok=True)
    print("üñºÔ∏è ‡πÅ‡∏õ‡∏•‡∏á PDF...")
    images = convert_from_path(PDF_FILE, dpi=DPI)
    for i, img in enumerate(images, 1):
        img.save(f"images/slide_{i:02d}.png", "PNG")
    return len(images)

def create_video(num_slides):
    print("üé¨ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠...")
    clips = []
    for i in range(1, num_slides + 1):
        img, aud = f"images/slide_{i:02d}.png", f"audio/slide_{i:02d}.mp3"
        if Path(aud).exists():
            audio = AudioFileClip(aud)
            clip = ImageClip(img).set_duration(audio.duration).set_audio(audio)
        else:
            clip = ImageClip(img).set_duration(5)
        clips.append(clip)
    final = concatenate_videoclips(clips, method="compose")
    final.write_videofile(OUTPUT_VIDEO, fps=24, codec="libx264", audio_codec="aac", verbose=False, logger=None)
    final.close()
    print(f"‚úÖ {OUTPUT_VIDEO}")

async def main():
    print(f"üé¨ Week 08: Docker Compose")
    if not Path(PDF_FILE).exists():
        print(f"‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö {PDF_FILE}")
        return
    await generate_all_audio()
    num = convert_pdf_to_images()
    create_video(min(num, len(SCRIPTS)))

if __name__ == "__main__":
    asyncio.run(main())
