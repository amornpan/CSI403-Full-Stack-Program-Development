"""
PDF to Video - Lab 08: CI/CD + Testing
"""
import asyncio
import edge_tts
from pathlib import Path
from pdf2image import convert_from_path
from moviepy.editor import ImageClip, AudioFileClip, concatenate_videoclips

PDF_FILE = "lab08.pdf"
OUTPUT_VIDEO = "lab08-cicd-testing.mp4"
VOICE = "th-TH-NiwatNeural"
RATE = "-15%"
DPI = 200

SCRIPTS = [
    """‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö... ‡πÅ‡∏•‡πá‡∏ö‡∏ó‡∏µ‡πà 8 ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á CI/CD ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏ó‡∏™‡∏ï‡∏¥‡πâ‡∏á...
    ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 3.75 ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏£‡∏±‡∏ö... ‡πÅ‡∏•‡πá‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß!...
    ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡∏™‡∏ï‡πå ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á CI/CD ‡πÑ‡∏õ‡∏õ‡πå‡πÑ‡∏•‡∏ô‡πå""",
    
    """‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô pytest ‡πÄ‡∏ó‡∏™‡∏ï‡πå...
    ‡∏™‡∏£‡πâ‡∏≤‡∏á CI/CD ‡πÑ‡∏õ‡∏õ‡πå‡πÑ‡∏•‡∏ô‡πå...
    ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GitHub Actions ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡πÅ‡∏£‡∏Å... ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô test_api.py ‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏≠‡∏¥‡∏°‡∏û‡∏≠‡∏£‡πå‡∏ï pytest ‡πÅ‡∏•‡∏∞ TestClient ‡∏à‡∏≤‡∏Å fastapi...
    ‡∏™‡∏£‡πâ‡∏≤‡∏á client ‡∏à‡∏≤‡∏Å app...
    ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô test_health ‡πÄ‡∏ä‡πá‡∏Ñ status code 200...
    ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô test_search ‡πÄ‡∏ä‡πá‡∏Ñ POST /search ‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡πÄ‡∏ó‡∏™‡∏ï‡πå‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á""",
    
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡∏ó‡∏µ‡πà 2... ‡∏£‡∏±‡∏ô‡πÄ‡∏ó‡∏™‡∏ï‡πå‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏û‡∏¥‡∏°‡∏û‡πå pytest tests/ -v ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ô‡πÅ‡∏ö‡∏ö verbose...
    ‡∏´‡∏£‡∏∑‡∏≠ pytest tests/ --cov=. --cov-report=html...
    ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π coverage report ‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡∏™‡∏ï‡πå‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô...
    coverage report ‡∏ä‡πà‡∏ß‡∏¢‡∏´‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ó‡∏™‡∏ï‡πå‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡∏ó‡∏µ‡πà 3... ‡∏™‡∏£‡πâ‡∏≤‡∏á Jenkinsfile ‡∏Ñ‡∏£‡∏±‡∏ö...
    Jenkinsfile ‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡πÑ‡∏õ‡∏õ‡πå‡πÑ‡∏•‡∏ô‡πå CI/CD...
    ‡∏°‡∏µ 3 stages... Build, Test, Deploy...
    stage Build ‡∏£‡∏±‡∏ô docker-compose build...
    stage Test ‡∏£‡∏±‡∏ô pytest...
    stage Deploy ‡∏£‡∏±‡∏ô docker-compose up -d ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡∏ó‡∏µ‡πà 4... ‡∏™‡∏£‡πâ‡∏≤‡∏á GitHub Actions ‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå .github/workflows/ci.yml...
    ‡∏Å‡∏≥‡∏´‡∏ô‡∏î trigger ‡πÄ‡∏°‡∏∑‡πà‡∏≠ push ‡∏´‡∏£‡∏∑‡∏≠ pull request...
    ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏ö‡∏ô ubuntu-latest...
    steps ‡∏°‡∏µ checkout, build, up, wait, health check ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° CI/CD ‡πÑ‡∏õ‡∏õ‡πå‡πÑ‡∏•‡∏ô‡πå‡∏Ñ‡∏£‡∏±‡∏ö...
    Push ‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ç‡∏∂‡πâ‡∏ô GitHub...
    ‡πÑ‡∏õ‡∏õ‡πå‡πÑ‡∏•‡∏ô‡πå ‡πÄ‡∏£‡∏¥‡πà‡∏° Build ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...
    ‡∏£‡∏±‡∏ô Test ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...
    ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πá Deploy ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...
    ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£ ‡∏î‡∏µ‡∏û‡∏•‡∏≠‡∏¢ ‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß ‡πÅ‡∏•‡∏∞‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡∏™‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß... ‡πÄ‡∏ó‡∏™‡∏ï‡πå‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...
    ‡∏™‡∏£‡πâ‡∏≤‡∏á Jenkinsfile ‡πÅ‡∏•‡πâ‡∏ß...
    ‡∏™‡∏£‡πâ‡∏≤‡∏á GitHub Actions workflow ‡πÅ‡∏•‡πâ‡∏ß...
    ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢...
    ‡πÄ‡∏î‡∏î‡πÑ‡∏•‡∏ô‡πå ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå 23:59 ‡∏Ñ‡∏£‡∏±‡∏ö!...
    ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 8 ‡πÅ‡∏•‡πá‡∏ö!""",
]

async def generate_audio(text, output_file):
    communicate = edge_tts.Communicate(text, VOICE, rate=RATE)
    await communicate.save(output_file)

async def generate_all_audio():
    Path("audio").mkdir(exist_ok=True)
    print("üé§ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á...")
    for i, script in enumerate(SCRIPTS, 1):
        await generate_audio(script, f"audio/slide_{i:02d}.mp3")
        print(f"  ‚úÖ Slide {i}/{len(SCRIPTS)}")

def convert_pdf_to_images():
    Path("images").mkdir(exist_ok=True)
    print("üñºÔ∏è ‡πÅ‡∏õ‡∏•‡∏á PDF...")
    images = convert_from_path(PDF_FILE, dpi=DPI)
    for i, img in enumerate(images, 1):
        img.save(f"images/slide_{i:02d}.png", "PNG")
    return len(images)

def create_video(num_slides):
    print("üé¨ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠...")
    clips = []
    for i in range(1, num_slides + 1):
        img, aud = f"images/slide_{i:02d}.png", f"audio/slide_{i:02d}.mp3"
        if Path(aud).exists():
            audio = AudioFileClip(aud)
            clip = ImageClip(img).set_duration(audio.duration).set_audio(audio)
        else:
            clip = ImageClip(img).set_duration(5)
        clips.append(clip)
    final = concatenate_videoclips(clips, method="compose")
    final.write_videofile(OUTPUT_VIDEO, fps=24, codec="libx264", audio_codec="aac", verbose=False, logger=None)
    final.close()
    print(f"‚úÖ {OUTPUT_VIDEO}")

async def main():
    print(f"üé¨ Lab 08: CI/CD + Testing")
    if not Path(PDF_FILE).exists():
        print(f"‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö {PDF_FILE}")
        return
    await generate_all_audio()
    num = convert_pdf_to_images()
    create_video(min(num, len(SCRIPTS)))

if __name__ == "__main__":
    asyncio.run(main())
