"""
PDF to Video - Lab 06: RAG + Local LLM + Streamlit
"""
import asyncio
import edge_tts
from pathlib import Path
from pdf2image import convert_from_path
from moviepy.editor import ImageClip, AudioFileClip, concatenate_videoclips

PDF_FILE = "lab06.pdf"
OUTPUT_VIDEO = "lab06-rag-llm-streamlit.mp4"
VOICE = "th-TH-NiwatNeural"
RATE = "-15%"
DPI = 200

SCRIPTS = [
    """‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö... ‡πÅ‡∏•‡πá‡∏ö‡∏ó‡∏µ‡πà 6 ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á RAG, Local LLM ‡πÅ‡∏•‡∏∞ Streamlit...
    ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 3.75 ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡πÅ‡∏•‡πá‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô... ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö RAG ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå""",
    
    """‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ‡πÇ‡∏≠‡∏•‡∏•‡∏≤‡∏°‡∏≤ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ô LLM ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á...
    ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ RAG ‡πÑ‡∏õ‡∏õ‡πå‡πÑ‡∏•‡∏ô‡πå ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£...
    ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ô Streamlit UI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡πÅ‡∏£‡∏Å... ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ‡πÇ‡∏≠‡∏•‡∏•‡∏≤‡∏°‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πà ollama.ai...
    ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°...
    ‡πÇ‡∏≠‡∏•‡∏•‡∏≤‡∏°‡∏≤ ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏£‡∏±‡∏ô LLM ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á...
    ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ API key ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡∏ó‡∏µ‡πà 2... ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏û‡∏¥‡∏°‡∏û‡πå ollama pull qwen2.5:7b...
    ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î 7 ‡∏û‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏ô ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå...
    ‡πÉ‡∏ä‡πâ‡πÅ‡∏£‡∏° ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 8 GB...
    ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏î‡∏µ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏û‡∏≠‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡∏ó‡∏µ‡πà 3... ‡∏ó‡∏î‡∏™‡∏≠‡∏ö LLM ‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏û‡∏¥‡∏°‡∏û‡πå ollama run qwen2.5:7b...
    ‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤ What is RAG?...
    ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö‡∏°‡∏≤‡πÑ‡∏î‡πâ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô...
    ‡∏Å‡∏î Ctrl+D ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡∏ó‡∏µ‡πà 4... ‡∏£‡∏±‡∏ô API ‡∏û‡∏£‡πâ‡∏≠‡∏° LLM ‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Generic-RAG...
    ‡∏£‡∏±‡∏ô python api.py...
    ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ API ‡∏à‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á ‡πÇ‡∏≠‡πÄ‡∏û‡πà‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä ‡πÅ‡∏•‡∏∞ ‡πÇ‡∏≠‡∏•‡∏•‡∏≤‡∏°‡∏≤...
    ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥ RAG ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡∏ó‡∏µ‡πà 5... ‡∏£‡∏±‡∏ô Streamlit ‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏û‡∏¥‡∏°‡∏û‡πå streamlit run app.py...
    ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏µ‡πà localhost:8501...
    ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤ UI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô RAG ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡∏ó‡∏µ‡πà 6... ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡πÄ‡∏õ‡∏¥‡∏î localhost:8501...
    ‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£...
    ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏°‡∏µ context ‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ñ‡∏£‡∏±‡∏ö...
    RAG Flow ‡∏Ñ‡∏∑‡∏≠... Query ‡πÑ‡∏õ Search ‡πÑ‡∏õ Retrieve ‡πÑ‡∏õ LLM ‡πÑ‡∏õ Response""",
    
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡∏ó‡∏µ‡πà 7... ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Prompt ‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡πÄ‡∏õ‡∏¥‡∏î api.py... ‡∏´‡∏≤ prompt template...
    ‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ LLM...
    ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡πÇ‡∏≠‡∏•‡∏•‡∏≤‡∏°‡∏≤ ‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ... LLM ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô...
    RAG ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£... Streamlit UI ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ...
    ‡πÄ‡∏î‡∏î‡πÑ‡∏•‡∏ô‡πå ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå 23:59 ‡∏Ñ‡∏£‡∏±‡∏ö!""",
]

async def generate_audio(text, output_file):
    communicate = edge_tts.Communicate(text, VOICE, rate=RATE)
    await communicate.save(output_file)

async def generate_all_audio():
    Path("audio").mkdir(exist_ok=True)
    print("üé§ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á...")
    for i, script in enumerate(SCRIPTS, 1):
        await generate_audio(script, f"audio/slide_{i:02d}.mp3")
        print(f"  ‚úÖ Slide {i}/{len(SCRIPTS)}")

def convert_pdf_to_images():
    Path("images").mkdir(exist_ok=True)
    print("üñºÔ∏è ‡πÅ‡∏õ‡∏•‡∏á PDF...")
    images = convert_from_path(PDF_FILE, dpi=DPI)
    for i, img in enumerate(images, 1):
        img.save(f"images/slide_{i:02d}.png", "PNG")
    return len(images)

def create_video(num_slides):
    print("üé¨ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠...")
    clips = []
    for i in range(1, num_slides + 1):
        img, aud = f"images/slide_{i:02d}.png", f"audio/slide_{i:02d}.mp3"
        if Path(aud).exists():
            audio = AudioFileClip(aud)
            clip = ImageClip(img).set_duration(audio.duration).set_audio(audio)
        else:
            clip = ImageClip(img).set_duration(5)
        clips.append(clip)
    final = concatenate_videoclips(clips, method="compose")
    final.write_videofile(OUTPUT_VIDEO, fps=24, codec="libx264", audio_codec="aac", verbose=False, logger=None)
    final.close()
    print(f"‚úÖ {OUTPUT_VIDEO}")

async def main():
    print(f"üé¨ Lab 06: RAG + LLM + Streamlit")
    if not Path(PDF_FILE).exists():
        print(f"‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö {PDF_FILE}")
        return
    await generate_all_audio()
    num = convert_pdf_to_images()
    create_video(min(num, len(SCRIPTS)))

if __name__ == "__main__":
    asyncio.run(main())
