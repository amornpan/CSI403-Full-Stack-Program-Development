"""
PDF to Video - Lab 05: Embeddings
"""
import asyncio
import edge_tts
from pathlib import Path
from pdf2image import convert_from_path
from moviepy.editor import ImageClip, AudioFileClip, concatenate_videoclips

PDF_FILE = "lab05.pdf"
OUTPUT_VIDEO = "lab05-embeddings.mp4"
VOICE = "th-TH-NiwatNeural"
RATE = "-15%"
DPI = 200

SCRIPTS = [
    """‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö... ‡πÅ‡∏•‡πá‡∏ö‡∏ó‡∏µ‡πà 5 ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÄ‡∏≠‡πá‡∏°‡πÄ‡∏ö‡∏î‡∏î‡∏¥‡πâ‡∏á‡∏™‡πå...
    ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 3.75 ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á ‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡πÄ‡∏≠‡πá‡∏°‡πÄ‡∏ö‡∏î‡∏î‡∏¥‡πâ‡∏á ‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£""",
    
    """‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏£‡∏±‡∏ô embedding.py ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á ‡πÄ‡∏≠‡πá‡∏°‡πÄ‡∏ö‡∏î‡∏î‡∏¥‡πâ‡∏á...
    ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Å‡∏≤‡∏£ ‡∏ä‡∏±‡∏á‡∏Å‡∏¥‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£...
    ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡πÅ‡∏£‡∏Å... ‡∏®‡∏∂‡∏Å‡∏©‡∏≤ embedding.py ‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡πÑ‡∏õ‡∏õ‡πå‡πÑ‡∏•‡∏ô‡πå ‡∏°‡∏µ 4 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô...
    ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå md_corpus...
    ‡∏ä‡∏±‡∏á‡∏Å‡πå ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏¢‡πà‡∏≠‡∏¢...
    ‡∏™‡∏£‡πâ‡∏≤‡∏á ‡πÄ‡∏≠‡πá‡∏°‡πÄ‡∏ö‡∏î‡∏î‡∏¥‡πâ‡∏á ‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏°‡πÄ‡∏î‡∏• bge-m3...
    ‡πÅ‡∏•‡πâ‡∏ß ‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡πá‡∏Å‡∏ã‡πå ‡∏•‡∏á ‡πÇ‡∏≠‡πÄ‡∏û‡πà‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä...
    bge-m3 ‡∏™‡∏£‡πâ‡∏≤‡∏á ‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå 1024 ‡∏°‡∏¥‡∏ï‡∏¥ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡∏ó‡∏µ‡πà 2... ‡∏£‡∏±‡∏ô ‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡πá‡∏Å‡∏ã‡πå‡∏ã‡∏¥‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Generic-RAG...
    ‡πÅ‡∏≠‡∏Ñ‡∏ó‡∏¥‡πÄ‡∏ß‡∏ó rag_env...
    ‡∏£‡∏±‡∏ô python embedding.py...
    ‡∏£‡∏≠‡∏à‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à... ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡∏ó‡∏µ‡πà 3... ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡πÉ‡∏ä‡πâ curl ‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£...
    curl localhost:9200/documents/_count...
    ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô count ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å ‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡πá‡∏Å‡∏ã‡πå ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ...
    ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡∏ó‡∏µ‡πà 4 ‡πÅ‡∏•‡∏∞ 5... ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå .md ‡πÉ‡∏´‡∏°‡πà 3 ‡πÑ‡∏ü‡∏•‡πå ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå md_corpus...
    ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏±‡∏ô python embedding.py ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á...
    ‡πÄ‡∏ä‡πá‡∏Ñ count ‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ... ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡∏ó‡∏µ‡πà 6... ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ...
    ‡πÉ‡∏ä‡πâ /search ‡πÄ‡∏≠‡∏ô‡∏î‡πå‡∏û‡∏≠‡∏¢‡∏ó‡πå...
    ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    """‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡πá‡∏Å‡∏ã‡πå‡∏ã‡∏¥‡πà‡∏á ‡πÄ‡∏™‡∏£‡πá‡∏à... ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß...
    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß... ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô...
    ‡πÄ‡∏î‡∏î‡πÑ‡∏•‡∏ô‡πå ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå 23:59 ‡∏Ñ‡∏£‡∏±‡∏ö!""",
]

async def generate_audio(text, output_file):
    communicate = edge_tts.Communicate(text, VOICE, rate=RATE)
    await communicate.save(output_file)

async def generate_all_audio():
    Path("audio").mkdir(exist_ok=True)
    print("üé§ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á...")
    for i, script in enumerate(SCRIPTS, 1):
        await generate_audio(script, f"audio/slide_{i:02d}.mp3")
        print(f"  ‚úÖ Slide {i}/{len(SCRIPTS)}")

def convert_pdf_to_images():
    Path("images").mkdir(exist_ok=True)
    print("üñºÔ∏è ‡πÅ‡∏õ‡∏•‡∏á PDF...")
    images = convert_from_path(PDF_FILE, dpi=DPI)
    for i, img in enumerate(images, 1):
        img.save(f"images/slide_{i:02d}.png", "PNG")
    return len(images)

def create_video(num_slides):
    print("üé¨ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠...")
    clips = []
    for i in range(1, num_slides + 1):
        img, aud = f"images/slide_{i:02d}.png", f"audio/slide_{i:02d}.mp3"
        if Path(aud).exists():
            audio = AudioFileClip(aud)
            clip = ImageClip(img).set_duration(audio.duration).set_audio(audio)
        else:
            clip = ImageClip(img).set_duration(5)
        clips.append(clip)
    final = concatenate_videoclips(clips, method="compose")
    final.write_videofile(OUTPUT_VIDEO, fps=24, codec="libx264", audio_codec="aac", verbose=False, logger=None)
    final.close()
    print(f"‚úÖ {OUTPUT_VIDEO}")

async def main():
    print(f"üé¨ Lab 05: Embeddings")
    if not Path(PDF_FILE).exists():
        print(f"‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö {PDF_FILE}")
        return
    await generate_all_audio()
    num = convert_pdf_to_images()
    create_video(min(num, len(SCRIPTS)))

if __name__ == "__main__":
    asyncio.run(main())
