"""
PDF to Video with Thai AI Voice - Lab 02: Docker + OpenSearch
==============================================================
"""

import asyncio
import edge_tts
from pathlib import Path
from pdf2image import convert_from_path
from moviepy.editor import ImageClip, AudioFileClip, concatenate_videoclips

# ============================================
# CONFIGURATION
# ============================================
PDF_FILE = "lab02.pdf"
OUTPUT_VIDEO = "lab02-docker-opensearch.mp4"
VOICE = "th-TH-NiwatNeural"
RATE = "-15%"
DPI = 200

# ============================================
# SCRIPTS - Lab 02: Docker + OpenSearch
# ============================================
SCRIPTS = [
    # Slide 1 - Title
    """‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô...
    ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà ‡πÅ‡∏•‡πá‡∏ö‡∏ó‡∏µ‡πà 2...
    ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏î‡πá‡∏≠‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå ‡πÅ‡∏•‡∏∞ ‡πÇ‡∏≠‡πÄ‡∏û‡πà‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä...
    ‡πÅ‡∏•‡πá‡∏ö‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 3.75 ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ ‡∏î‡πá‡∏≠‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå ‡∏£‡∏±‡∏ô ‡πÇ‡∏≠‡πÄ‡∏û‡πà‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå""",
    
    # Slide 2 - Objectives
    """‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πá‡∏ö‡∏ô‡∏µ‡πâ‡∏°‡∏µ 3 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏Ç‡πâ‡∏≠‡πÅ‡∏£‡∏Å... ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ‡∏î‡πá‡∏≠‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå ‡πÄ‡∏î‡∏™‡∏Å‡πå‡∏ó‡πá‡∏≠‡∏õ...
    ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏á... ‡∏£‡∏±‡∏ô ‡πÇ‡∏≠‡πÄ‡∏û‡πà‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå...
    ‡∏Ç‡πâ‡∏≠‡∏™‡∏≤‡∏°... ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ‡πÑ‡∏Æ‡∏ö‡∏£‡∏¥‡∏î ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä ‡πÑ‡∏õ‡∏õ‡πå‡πÑ‡∏•‡∏ô‡πå...
    ‡πÇ‡∏≠‡πÄ‡∏û‡πà‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä ‡∏Ñ‡∏∑‡∏≠ ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä‡πÄ‡∏≠‡∏ô‡∏à‡∏¥‡∏ô ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    # Slide 3 - Task 1: Install Docker
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡πÅ‡∏£‡∏Å... ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ‡∏î‡πá‡∏≠‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå ‡πÄ‡∏î‡∏™‡∏Å‡πå‡∏ó‡πá‡∏≠‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πà docker.com...
    ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°...
    ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á docker --version...
    ‡∏ñ‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏°‡∏≤ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à...
    ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç... ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î ‡∏î‡πá‡∏≠‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå ‡πÄ‡∏î‡∏™‡∏Å‡πå‡∏ó‡πá‡∏≠‡∏õ ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    # Slide 4 - Task 2: Run OpenSearch
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡∏ó‡∏µ‡πà 2... ‡∏£‡∏±‡∏ô ‡πÇ‡∏≠‡πÄ‡∏û‡πà‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á docker run ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á...
    -d ‡∏Ñ‡∏∑‡∏≠‡∏£‡∏±‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á...
    -p 9200:9200 ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏û‡∏≠‡∏£‡πå‡∏ï 9200...
    discovery.type=single-node ‡∏Ñ‡∏∑‡∏≠‡∏£‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡πÇ‡∏´‡∏ô‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß...
    ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ‡∏≠‡∏¥‡∏°‡πÄ‡∏°‡∏à ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...
    ‡∏û‡∏≠‡∏£‡πå‡∏ï 9200 ‡∏Ñ‡∏∑‡∏≠ REST API...
    ‡∏û‡∏≠‡∏£‡πå‡∏ï 9600 ‡∏Ñ‡∏∑‡∏≠ Performance Analyzer ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    # Slide 5 - Task 3: Verify
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡∏ó‡∏µ‡πà 3... ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ ‡πÇ‡∏≠‡πÄ‡∏û‡πà‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏û‡∏¥‡∏°‡∏û‡πå curl http://localhost:9200...
    ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ JSON ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à...
    ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠ opensearch-node...
    cluster_name ‡πÄ‡∏õ‡πá‡∏ô docker-cluster...
    ‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 2.11.1...
    ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ JSON ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå ‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    # Slide 6 - Task 4: Hybrid Search Pipeline
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡∏ó‡∏µ‡πà 4... ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ‡πÑ‡∏Æ‡∏ö‡∏£‡∏¥‡∏î ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä ‡πÑ‡∏õ‡∏õ‡πå‡πÑ‡∏•‡∏ô‡πå‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡πÑ‡∏Æ‡∏ö‡∏£‡∏¥‡∏î ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏° ‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä ‡∏Å‡∏±‡∏ö BM25 ‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô...
    ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á curl PUT ‡∏™‡∏£‡πâ‡∏≤‡∏á ‡πÑ‡∏õ‡∏õ‡πå‡πÑ‡∏•‡∏ô‡πå...
    ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ normalization ‡πÄ‡∏õ‡πá‡∏ô min_max...
    combination ‡πÄ‡∏õ‡πá‡∏ô arithmetic_mean...
    weights 0.3 ‡πÅ‡∏•‡∏∞ 0.7...
    ‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤ ‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä ‡∏°‡∏µ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å 70 ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    # Slide 7 - Task 5: Check Health
    """‡∏ó‡∏≤‡∏™‡∏Ñ‡πå‡∏ó‡∏µ‡πà 5... ‡πÄ‡∏ä‡πá‡∏Ñ ‡πÄ‡∏Æ‡∏•‡∏ò‡πå ‡∏Ç‡∏≠‡∏á ‡∏Ñ‡∏•‡∏±‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏û‡∏¥‡∏°‡∏û‡πå curl http://localhost:9200/_cluster/health?pretty...
    ‡∏î‡∏π‡∏ó‡∏µ‡πà status... ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô green ‡∏´‡∏£‡∏∑‡∏≠ yellow ‡∏Ñ‡∏∑‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥...
    number_of_nodes ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô 1...
    ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô red ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‡∏•‡πá‡∏≠‡∏Å ‡∏Ñ‡∏£‡∏±‡∏ö""",
    
    # Slide 8 - Deliverables
    """‡∏°‡∏≤‡∏î‡∏π‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏´‡∏ô‡∏∂‡πà‡∏á... ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ‡∏î‡πá‡∏≠‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à...
    ‡∏™‡∏≠‡∏á... ‡πÇ‡∏≠‡πÄ‡∏û‡πà‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ä ‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ...
    ‡∏™‡∏≤‡∏°... ‡∏™‡∏£‡πâ‡∏≤‡∏á ‡πÑ‡∏õ‡∏õ‡πå‡πÑ‡∏•‡∏ô‡πå ‡πÅ‡∏•‡πâ‡∏ß...
    ‡∏™‡∏µ‡πà... ‡∏ñ‡πà‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡∏ó‡∏∏‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô...
    ‡πÄ‡∏î‡∏î‡πÑ‡∏•‡∏ô‡πå ‡∏Ñ‡∏∑‡∏≠ ‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå 23:59 ‡∏Ñ‡∏£‡∏±‡∏ö...
    ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡πÅ‡∏•‡πá‡∏ö‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö!""",
]

# ============================================
# FUNCTIONS (same as lab01)
# ============================================

async def generate_audio(text: str, output_file: str):
    communicate = edge_tts.Communicate(text, VOICE, rate=RATE)
    await communicate.save(output_file)

async def generate_all_audio():
    audio_dir = Path("audio")
    audio_dir.mkdir(exist_ok=True)
    print("üé§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á AI...")
    for i, script in enumerate(SCRIPTS, 1):
        output_file = audio_dir / f"slide_{i:02d}.mp3"
        await generate_audio(script, str(output_file))
        print(f"  ‚úÖ Slide {i}/{len(SCRIPTS)}")
    print("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!\n")

def convert_pdf_to_images():
    images_dir = Path("images")
    images_dir.mkdir(exist_ok=True)
    print("üñºÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á PDF ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...")
    images = convert_from_path(PDF_FILE, dpi=DPI)
    for i, image in enumerate(images, 1):
        output_file = images_dir / f"slide_{i:02d}.png"
        image.save(str(output_file), "PNG")
        print(f"  ‚úÖ Slide {i}/{len(images)}")
    print("‚úÖ ‡πÅ‡∏õ‡∏•‡∏á PDF ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!\n")
    return len(images)

def create_video(num_slides: int):
    print("üé¨ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠...")
    clips = []
    total_duration = 0
    for i in range(1, num_slides + 1):
        image_file = f"images/slide_{i:02d}.png"
        audio_file = f"audio/slide_{i:02d}.mp3"
        if not Path(audio_file).exists():
            duration = 5
            clip = ImageClip(image_file).set_duration(duration)
        else:
            audio = AudioFileClip(audio_file)
            duration = audio.duration
            clip = ImageClip(image_file).set_duration(duration)
            clip = clip.set_audio(audio)
        clips.append(clip)
        total_duration += duration
        print(f"  ‚úÖ Slide {i}/{num_slides} ({duration:.1f}s)")
    print(f"\nüìä ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏£‡∏ß‡∏°: {total_duration/60:.1f} ‡∏ô‡∏≤‡∏ó‡∏µ")
    print("\nüìº ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏°‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠...")
    final_video = concatenate_videoclips(clips, method="compose")
    print("üíæ ‡∏Å‡∏≥‡∏•‡∏±‡∏á export ‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠...")
    final_video.write_videofile(OUTPUT_VIDEO, fps=24, codec="libx264", audio_codec="aac", threads=4, preset="medium", verbose=False, logger=None)
    final_video.close()
    for clip in clips:
        clip.close()
    print(f"\n‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏µ‡∏î‡∏µ‡πÇ‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå: {OUTPUT_VIDEO}")

async def main():
    print("=" * 60)
    print("üé¨ Video Generator - Lab 02: Docker + OpenSearch")
    print("=" * 60)
    if not Path(PDF_FILE).exists():
        print(f"‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå PDF: {PDF_FILE}")
        return
    await generate_all_audio()
    num_slides = convert_pdf_to_images()
    create_video(min(num_slides, len(SCRIPTS)))
    print("\nüéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!")

if __name__ == "__main__":
    asyncio.run(main())
